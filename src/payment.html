<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Complete Payment</title>
  <link rel="stylesheet" href="styles.css">
  <script src="https://sdk.cashfree.com/js/v3/cashfree.js"></script>
</head>

<body class="payment-screen"
  style="background-image: url('../assets/background.png'); background-size: cover; background-position: center; background-repeat: no-repeat;">

  <div class="container">
    <div class="payment-header" style="position:relative;">
      <h1 class="title" style="margin:0; text-align:center;">Scan & Pay</h1>
      <p class="subtitle">Scan the QR code with any UPI app to complete payment</p>
    </div>

    <div class="qr-container">
      <div id="qr-code-wrapper" class="qr-code-wrapper loading">
        <div class="loader-overlay"></div>
        <div class="loader"></div>
        <div id="upi-qr"></div>
      </div>

      <div class="payment-details">
        <div class="amount-display">
          <span class="currency">₹</span>
          <span id="amount" class="amount">200</span>
        </div>
        <p class="payment-info">for 2 strip copies</p>
      </div>
    </div>

    <div class="timer-container">
      <p>QR Code expires in: <span id="timer" class="timer">5:00</span></p>
    </div>

    <div id="status-message" class="status-message"></div>
  </div>

  <script>
    let qrCodeId = null;
    let paymentCheckInterval = null;
    let expiryTime = null;
    let timerInterval = null;
    let expirySeconds = 300;

    window.addEventListener('DOMContentLoaded', async () => {
      const config = await window.electronAPI.getConfig();

      expirySeconds = ((config && config.payment && Number(config.payment.qrCodeExpiryMinutes))
        ? Number(config.payment.qrCodeExpiryMinutes) * 60
        : 300);

      const amountInRupees =
        Number(localStorage.getItem('orderAmount')) ||
        config.payment.amountInRupees;

      document.getElementById('amount').textContent = amountInRupees;
      document.getElementById('timer').textContent =
        `${Math.floor(expirySeconds / 60)}:00`;

      await generateQRCode(amountInRupees);
      startPaymentCheck();
      startExpiryTimer(expirySeconds);
    });

    async function generateQRCode(amountInRupees) {
      try {
        const res = await window.electronAPI.createQRCode(
          amountInRupees * 100,
          'Pixora Photo Session'
        );

        if (!res.success || !res.payment_session_id) {
          throw new Error('Invalid Cashfree response');
        }

        qrCodeId = res.order_id;

        const wrapperEl = document.getElementById('qr-code-wrapper');
        if (wrapperEl) wrapperEl.classList.remove('loading');

        const cashfree = Cashfree({
          mode: res.env === 'production' ? 'production' : 'sandbox'
        });

        /* ✅ CORRECT CASHFREE QR RENDER */
        cashfree.checkout({
          paymentSessionId: res.payment_session_id,
          redirectTarget: "_self",
          paymentMethod: {
            upi: { flow: "qr" }
          }
        });

      } catch (e) {
        console.error('QR generation failed', e);
        showError('Failed to generate QR');
      }
    }

    function startPaymentCheck() {
      paymentCheckInterval = setInterval(async () => {
        if (!qrCodeId) return;

        try {
          const res = await window.electronAPI.checkPayment(qrCodeId);
          if (res.success && res.paid) {
            cleanup();
            await window.electronAPI.notifyPaymentComplete();
            await window.electronAPI.quitApp();
          }
        } catch (e) {
          console.error('Payment check failed', e);
        }
      }, 2000);
    }

    function startExpiryTimer(seconds) {
      expiryTime = Date.now() + seconds * 1000;

      timerInterval = setInterval(() => {
        const remaining = Math.max(0, expiryTime - Date.now());
        const m = Math.floor(remaining / 60000);
        const s = Math.floor((remaining % 60000) / 1000);

        document.getElementById('timer').textContent =
          `${m}:${String(s).padStart(2, '0')}`;

        if (remaining <= 0) {
          cleanup();
          location.reload();
        }
      }, 1000);
    }

    function cleanup() {
      if (paymentCheckInterval) clearInterval(paymentCheckInterval);
      if (timerInterval) clearInterval(timerInterval);
    }

    function showError(msg) {
      const el = document.getElementById('status-message');
      el.textContent = msg;
      el.style.display = 'block';
    }
  </script>

</body>
</html>

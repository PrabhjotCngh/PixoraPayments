<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Complete Payment</title>
  <link rel="stylesheet" href="styles.css">
  <!-- Cashfree UI SDK for UPI components (use stable alias to avoid 404s) -->
  <script src="https://sdk.cashfree.com/js/v3/cashfree.js"></script>
</head>
<body class="payment-screen" style="background-image: url('../assets/background.png'); background-size: cover; background-position: center; background-repeat: no-repeat;">

  <div class="container">
    <div class="payment-header" style="position:relative;">
      <h1 class="title" style="margin:0; text-align:center;">Scan & Pay</h1>
      <p class="subtitle">Scan the QR code with any UPI app to complete payment</p>
    </div>
    <div id="highlight-message" class="highlight-message" style="display:none;"></div>
    
    <div class="qr-container">
      <div id="qr-code-wrapper" class="qr-code-wrapper loading">
        <div class="loader-overlay" aria-hidden="true"></div>
        <div class="loader" aria-label="Loading"></div>
        <div id="upi-qr"></div>
      </div>
      
      <div class="payment-details">
        <div class="amount-display">
          <span class="currency">â‚¹</span>
          <span id="amount" class="amount">50</span>
        </div>
        <p class="payment-info">for 2 strip copies</p>
      </div>
    </div>
    
    
    
    <div class="timer-container">
      <p>QR Code expires in: <span id="timer" class="timer">5:00</span></p>
    </div>
    
    <button id="cancel-btn" class="btn btn-secondary">Cancel</button>

    <div id="status-message" class="status-message"></div>
  </div>

  <!-- Device connection badge -->
  <div id="device-badge" class="device-badge"></div>

  <script>
    let qrCodeId = null;
    let paymentCheckInterval = null;
    let config = null;
    let expiryTime = null;
    let timerInterval = null;

    window.addEventListener('DOMContentLoaded', async () => {
      config = await window.electronAPI.getConfig();
      // Show device connection badge
      try {
        const id = await (window.electronAPI && window.electronAPI.getDeviceId ? window.electronAPI.getDeviceId() : Promise.resolve(''));
        const badge = document.getElementById('device-badge');
        if (badge && id) badge.textContent = `Connected as ${id}`;
      } catch (_) {}


      // Read selection from localStorage (fallback to config)
      const selectedAmount = parseInt(localStorage.getItem('orderAmount') || '', 10);
      const selectedCount = parseInt(localStorage.getItem('orderCount') || '', 10);
      const amountInRupees = Number.isFinite(selectedAmount) ? selectedAmount : config.payment.amountInRupees;
      const photoCount = Number.isFinite(selectedCount) ? selectedCount : 2;

      // Display amount and description
      document.getElementById('amount').textContent = amountInRupees;
      const infoEl = document.querySelector('.payment-info');
      if (infoEl) infoEl.textContent = `for ${photoCount} ${photoCount === 2 ? 'strip copies' : 'photos'}`;

      // Static QR mode toggle
      const useGateway = !(config && config.payment && config.payment.usePaymentGateway === false);

      if (useGateway) {
        // Generate dynamic QR via Cashfree and start polling
        await generateQRCode(amountInRupees, photoCount);
        startPaymentCheck();
        startExpiryTimer(config.payment.qrCodeExpiryMinutes * 60);
      } else {
        // Render static QR image and enable tap-to-continue
        const wrapperEl = document.getElementById('qr-code-wrapper');
        const qrMountEl = document.getElementById('upi-qr');
        if (qrMountEl) qrMountEl.innerHTML = '';
        const staticPath = (config.assets && config.assets.staticQrImage) || '../assets/static_qr.png';
        const img = document.createElement('img');
        img.src = staticPath;
        img.alt = 'Static UPI QR';
        img.className = 'qr-image';
        img.onload = () => { if (wrapperEl) wrapperEl.classList.remove('loading'); };
        img.onerror = () => { if (wrapperEl) wrapperEl.classList.remove('loading'); };
        qrMountEl.appendChild(img);

        const msg = document.getElementById('highlight-message');
        if (msg) {
          msg.textContent = 'Once payment is done, tap anywhere to continue';
          msg.style.display = 'block';
        }

        let tapped = false;
        const tapHandler = async () => {
          if (tapped) return;
          tapped = true;
            try { await window.electronAPI.notifyPaymentComplete(); } catch (_) {}
          try { await window.electronAPI.quitApp(); } catch (_) {}
        };
        document.body.addEventListener('click', tapHandler);
        document.body.addEventListener('touchstart', tapHandler);

        startExpiryTimer(config.payment.qrCodeExpiryMinutes * 60);
      }
      
      // Cancel button -> launch DSLR app
      const cancelBtn = document.getElementById('cancel-btn');
      if (cancelBtn) {
        cancelBtn.addEventListener('click', async () => {
          cleanup();
            try { await window.electronAPI.notifyPaymentComplete(); } catch (_) {}
          try { await window.electronAPI.quitApp(); } catch (_) {}
        });
      }
    });

    async function generateQRCode(amountInRupees, photoCount) {
      try {
        const amount = amountInRupees * 100; // Convert to paise
        const description = `Photobooth Session - ${photoCount} ${photoCount === 2 ? 'strip copies' : 'photos'}`;

        // Create order via backend (returns order_id and payment_session_id)
        const response = await window.electronAPI.createQRCode(amount, description);

        if (response.success) {
          const { id, order_id, payment_session_id, payment_link, image_url } = response.qrCode;
          qrCodeId = order_id || id;

          // Initialize Cashfree UI SDK using env (fallback to hostname heuristic)
          let cfMode = 'production';
          try {
            const envMode = await (window.electronAPI && window.electronAPI.getCashfreeEnv ? window.electronAPI.getCashfreeEnv() : Promise.resolve('production'));
            cfMode = (envMode === 'production') ? 'production' : 'sandbox';
          } catch (_) {
            cfMode = (window.location.hostname === 'localhost' ? 'sandbox' : 'production');
          }
          const cashfree = Cashfree({ mode: cfMode });

          // Mount the UPI QR component into the dedicated container
          const wrapperEl = document.getElementById('qr-code-wrapper');
          const qrMountEl = document.getElementById('upi-qr');
          if (qrMountEl) qrMountEl.innerHTML = '';

          const upiQr = cashfree.create('upiQr', {
            values: {
              size: '280px',
              // Pass payment session if SDK supports it; kept for forward compatibility
              payment_session_id: payment_session_id
            }
          });

          // Handle component load errors
          upiQr.on('loaderror', function (data) {
            console.error('Cashfree UPI QR load error:', data?.error);
            // Fallbacks: try local QR render from payment_link, else static image
            if (payment_link && window.QRCode && qrMountEl) {
              renderLocalQR(payment_link);
              if (wrapperEl) wrapperEl.classList.remove('loading');
            } else if (image_url && qrMountEl) {
              qrMountEl.innerHTML = `<img src="${image_url}" alt="UPI QR Code" class="qr-image">`;
              if (wrapperEl) wrapperEl.classList.remove('loading');
            } else {
              showError('Failed to load UPI QR. Please try again.');
              if (wrapperEl) wrapperEl.classList.remove('loading');
            }
          });

          // Mount the component
          upiQr.mount('#upi-qr');

          // Ready event (optional debug)
          upiQr.on('ready', function (d) {
            // Hide loader once component is ready
            if (wrapperEl) wrapperEl.classList.remove('loading');
          });
        } else {
          showError('Failed to create payment order. Please try again.');
          const wrapperEl = document.getElementById('qr-code-wrapper');
          if (wrapperEl) wrapperEl.classList.remove('loading');
        }
      } catch (error) {
        console.error('Error generating QR/component:', error);
        showError('Error generating QR code: ' + error.message);
        const wrapperEl = document.getElementById('qr-code-wrapper');
        if (wrapperEl) wrapperEl.classList.remove('loading');
      }
    }

    function startPaymentCheck() {
      const pollMs = (config && config.screens && Number(config.screens.qrCodeRefreshInterval)) || 2000;
      paymentCheckInterval = setInterval(async () => {
        if (!qrCodeId) return;
        
        try {
          const response = await window.electronAPI.checkPayment(qrCodeId);
          // Check amount as well to avoid false positives
          const expectedAmount = Number(document.getElementById('amount').textContent);
          const paidAmount = Number(
            (response.amountInRupees !== undefined ? response.amountInRupees :
             response.amount !== undefined ? response.amount / 100 : // if in paise
             0)
          );
          const amountMatches = Number.isFinite(paidAmount) && paidAmount === expectedAmount;

          if (response.success && response.paid && amountMatches) {
            cleanup();
            // Notify bridge that payment completed, then quit Pixora
            try { await window.electronAPI.notifyPaymentComplete(); } catch (_) {}
            try { await window.electronAPI.quitApp(); } catch (_) {}
          }
        } catch (error) {
          console.error('Error checking payment:', error);
        }
      }, pollMs); // Poll interval from config (ms), fallback 2000ms
    }

    function startExpiryTimer(seconds) {
      expiryTime = Date.now() + (seconds * 1000);
      
      timerInterval = setInterval(() => {
        const remaining = Math.max(0, expiryTime - Date.now());
        const minutes = Math.floor(remaining / 60000);
        const secs = Math.floor((remaining % 60000) / 1000);
        
        document.getElementById('timer').textContent = 
          `${minutes}:${secs.toString().padStart(2, '0')}`;
        
        if (remaining <= 0) {
          cleanup();
          // Expired -> show failure screen
          window.location.href = 'failure.html?reason=expired';
        }
      }, 1000);
    }

    function cleanup() {
      if (paymentCheckInterval) clearInterval(paymentCheckInterval);
      if (timerInterval) clearInterval(timerInterval);
    }

    function showError(message) {
      const statusEl = document.getElementById('status-message');
      statusEl.textContent = message;
      statusEl.style.display = 'block';
      statusEl.classList.add('error');
    }
  </script>
</body>
</html>
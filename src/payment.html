<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Complete Payment</title>
  <link rel="stylesheet" href="styles.css">
  <script src="https://sdk.cashfree.com/js/v3/cashfree.js"></script>
</head>

<body class="payment-screen"
  style="background-image: url('../assets/background.png'); background-size: cover; background-position: center; background-repeat: no-repeat;">

  <div class="container">

    <div id="qr-code-wrapper" class="qr-code-wrapper loading"
      style="position: relative; min-height: 60vh; width: 100%;">
      <div class="loader" style="width: 96px; height: 96px; border-width: 12px;"></div>
      <div id="upi-qr"></div>
    </div>

  </div>

  <script>
    let qrCodeId = null;

    window.addEventListener('DOMContentLoaded', async () => {
      const config = await window.electronAPI.getConfig();
      const amountInRupees = Number(localStorage.getItem('orderAmount')) || config.payment.amountInRupees;
      // Show loader while loading QR
      const wrapperEl = document.getElementById('qr-code-wrapper');
      if (wrapperEl) wrapperEl.classList.add('loading');
      await generateQRCode(amountInRupees);
    });

    async function generateQRCode(amountInRupees) {
      try {
        const res = await window.electronAPI.createQRCode(
          amountInRupees * 100,
          'Pixora Photo Session'
        );
        const wrapperEl = document.getElementById('qr-code-wrapper');
        if (!res?.success || !res?.qrCode?.payment_session_id) {
          if (wrapperEl) wrapperEl.classList.remove('loading');
          throw new Error('Invalid Cashfree response');
        }
        qrCodeId = res?.qrCode?.order_id;
        if (wrapperEl) wrapperEl.classList.remove('loading');
        const cashfree = Cashfree({ mode: res?.qrCode?.env });
        cashfree.checkout({
          paymentSessionId: res?.qrCode?.payment_session_id,
          redirectTarget: "_self",
          paymentMethod: { upi: { flow: "qr" } }
        });
      } catch (e) {
        const wrapperEl = document.getElementById('qr-code-wrapper');
        if (wrapperEl) wrapperEl.classList.remove('loading');
        console.error('QR generation failed', e);
        showError('Failed to generate QR');
      }
    }

  </script>

</body>

</html>